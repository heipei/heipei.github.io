<!DOCTYPE html>
<html xmlns="https://www.w3.org/1999/xhtml" xml:lang="en" lang="en-gb">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <title>SSH Agent Forwarding considered harmful</title>
        <meta name="author" content="Johannes Gilger" />
        <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">
        <link rel="stylesheet" href="/css/syntax.css" type="text/css" media="all" />
        <link rel="stylesheet" href="/css/screen.css" type="text/css" media="all" />
        <link rel="canonical" href="https://heipei.github.io/2015/02/26/SSH-Agent-Forwarding-considered-harmful/" />
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
             (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
             m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
             })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-40830475-1', 'github.io');
            ga('send', 'pageview');
        </script>
    </head>
    <body>
        <div class="header">
            <div class="site">
                <div class="title"><a href="/">Johannes 'heipei' Gilger</a><div class="block1"></div><div class="block2"></div><div class="block3"></div></div>
            </div>
        </div>
        <div class="site">
            <div id="post">
	<h1>SSH Agent Forwarding considered harmful</h1>
	<p class="meta">26 Feb 2015</p>
	<p><strong>tl;dr</strong>: Don’t use SSH <code>ForwardAgent</code>, it’s stupid and insecure. Use <code>ProxyCommand</code> instead.</p>

<ul>
  <li><a href="https://news.ycombinator.com/item?id=9425805">Hackernews thread on this post</a></li>
  <li><a href="https://www.reddit.com/r/netsec/comments/2xdcgx/ssh_agent_forwarding_considered_harmful/">r/netsec thread on this post</a></li>
</ul>

<h1 id="introduction">Introduction</h1>

<p>Since I recently saw <a href="https://www.reddit.com/r/netsec/comments/2m2zpb/the_perils_of_using_an_sshagent/">a post on Reddit
netsec</a>
which sadly omitted what to use instead of ssh-agent, I felt it was time to
write yet another discussion about the perils of what is a useless workflow at
best and a dangerous habit at worst. I’ll show a simpler, more secure and more
powerful alternative in the form of SSH <code>ProxyCommand</code>.</p>

<h1 id="the-problem-with-ssh-agent-forwarding">The problem with SSH Agent Forwarding</h1>

<p>SSH Agent Forwarding can be enabled by calling <code>ssh -A</code> or by setting the
<code>AgentForward</code> flag in your config. It is meant as an easy way to connect to a
host A with your SSH key and from there connect to another host B with that
same key. This obviously is only needed if you cannot connect to host B
directly from your workstation.</p>

<p>The problem is that while you’re connected to host A, a forwarding socket will
be set up so that the SSH client on host A can connect to the ssh-agent on your
workstation to perform authentication on its behalf. This means that anyone
with sufficient permission on host A will be able to use that socket to connect
to and use your local ssh-agent. It could be the root user or anyone else who
managed to compromise host A. The result is that the user would be able to
impersonate you to any host as long as you’re connected to host A.</p>

<p>You might say that host A only belongs to yourself, there is no other user on
it, even less so someone with root access. But then again: Why take the chance?
The probability of encountering a compromised machine increases with the number
of hosts you connect to, and I know most people consider their workstation
their most secure host.</p>

<p>You might also say that the window of compromise is small since it is only open
while you’re connected to host A. Again: Why take the risk? This is like having
unprotected sex only for a short amount of time. And sometimes you <em>do</em> leave
that SSH session open while you’re out for lunch or something is processing in
the background.</p>

<p>Then there is the last line of reasoning: Only using a dedicated key for
forwarding to host A. This argument also becomes void if you consider that
someone who originally only had access to host A can now also access host B.
And furthermore, keeping track of which keys have been added to your local
ssh-agent is a tedious task. SSH is very promiscuous when it comes to using SSH
keys, and once you make use of another key it will happily add that to your
current agent session.</p>

<p>Lastly, SSH Agent Forwarding only works for interactive sessions which gives it
that very ghetto feeling of missing out on basically all the great features SSH
has to offer. Ever copied a file to host A and then to host B? You’re doing it
wrong!</p>

<h1 id="the-alternative-proxycommand-to-the-rescue">The alternative: ProxyCommand to the rescue</h1>

<p>If you’re still reading this, chances are that you’re not aware of the awesome
toolbox that is SSH (or at least OpenSSH, let’s be honest).</p>

<p>OpenSSH has an option called <code>ProxyCommand</code>. It works by specifying a
ProxyCommand to connect to host B. The config would look like this for our
simple example:</p>

<figure class="highlight"><pre><code class="language-apache" data-lang="apache"><span class="lineno">1</span> <span class="nb">Host</span> hosta
<span class="lineno">2</span> 	<span class="nb">User</span> userfoo
<span class="lineno">3</span> 	<span class="nb">Hostname</span> <span class="m">123.123.123.123</span>
<span class="lineno">4</span> 
<span class="lineno">5</span> <span class="nb">Host</span> hostb
<span class="lineno">6</span> 	<span class="nb">User</span> userbar
<span class="lineno">7</span> 	<span class="nb">Hostname</span> <span class="m">192.168.1.1</span>
<span class="lineno">8</span> 	<span class="nb">Port</span> <span class="m">2222</span>
<span class="lineno">9</span> 	<span class="nb">ProxyCommand</span> ssh -q -W %h:%p hosta</code></pre></figure>

<p>This config tells your local SSH client to connect to host A via a direct
connection. Now, if you type <code>ssh hostb</code> what it will do is connect to host A
first and then forward your SSH client via the <code>ProxyCommand</code> to the host and
port specified by the <code>-W</code> parameter, in this case I used <code>192.168.1.1</code> to
underline that this is an <em>internal</em> host. Your local SSH client will then
authenticate to host B as if you were connected to it directly.</p>

<p>Another observation here is that you don’t need to memorize anything about the
host, neither it’s IP or obscure hostname, port or username when you can simply
alias it with the <code>Host</code> line.</p>

<h1 id="legitimate-uses-of-forwardagent">Legitimate uses of ForwardAgent</h1>

<p>I’ve been trying to come up with legitimate reasons for using SSH agent
forwarding but failed to do so. I’ve only recently discovered one case where
agent forwarding is not only useful but also secure: Namespaces.</p>

<p>With Linux namespaces (filesystem, process, network namespaces) processes can
be put into their own namespaces on the same machine. This is something that
makes Docker work, but it can also be used standalone to create a number of
different networking setups. If you run <code>sshd</code> in your separate network
namespace, you can then ssh into that namespace to work from there and connect
to the host only reachable from the namespace. Since you’re connecting to your
own machine, forwarding your ssh-agent does not increase the attack surface:
It’s still your machine.</p>

<p>What would the alternative look like? Well, you can ssh into your namespace,
spawn a separate ssh-agent there and then add all your keys to that, typing
each passphrase again. Or you could create a <code>ProxyCommand</code> to use your
namespace as an intermediate host, either globally or per-host. But then you’d
have to toggle that on and off if you ever want to connect to the host directly
as opposed to through the namespace. Here, a simple <code>ssh -A</code> clearly wins in
terms of convenience.</p>

<h1 id="conclusion">Conclusion</h1>

<p>By now you should have some idea about why not to use SSH Agent Forwarding. If
you do have a legitimate use-case which I haven’t covered here, feel free to
leave it in the comments. I’ll follow up this post with a general breakdown of
some of the awesome features that SSH has to offer. The <code>ProxyCommand</code> will
play a key role, but there are lot’s of other goodies hidden inside OpenSSH.</p>

<h1 id="updates---march-4-2015">Updates - March 4 2015</h1>

<p>After I posted this post on <a href="https://www.reddit.com/r/netsec/">r/netsec</a> it
quickly got quite few replies and some interesting discussions developed. As I
mentioned in the post I was open for suggestions where ssh-agent might be hard
to replace and how to use it more securely.</p>

<p>One thing a number of people mentioned was using <code>ssh-agent -c</code> which will show
a confirmation window each time some program wants to use the agent to
authenticate somewhere. This is certainly a cool feature, though it will also
trigger for local users (i.e. you) and thus might be annoying.</p>

<p>As for reasons to use SSH Agent Forwarding in the first place, there was one
argument which I can relate to: Performance. If the hosts (jump-host and target
host) are behind a slow uplink and you frequently have to get data from one
host to the other it really sucks having to copy everything to your local
workstation and then back up. Unless a dedicated key which resides on either of
the hosts does the trick you’re stuck with Agent Forwarding.</p>

<p>The other reason I heard was “convenience”. As I’ll show with my next post on
SSH, Agent Forwarding is a lot less convenient in a number of ways.</p>

<p>A big problem about Agent Forwarding I forgot to mention is this by the way: If
an attacker compromises Host A he can not only use your forwarded agent when
you’re connected but he is actually able to eavesdrop on your ongoing session.
So even if you had an additional layer of security on Host B (password,
time-based token), the attacker could read and modify everything about your
session. ProxyCommand will prevent this from happening since the SSH session to
Host B terminates on your workstation!</p>

<h1 id="references">References</h1>

<ul>
  <li><a href="https://news.ycombinator.com/item?id=9425805">Hackernews thread on this post</a></li>
  <li><a href="https://www.reddit.com/r/netsec/comments/2xdcgx/ssh_agent_forwarding_considered_harmful/">r/netsec thread on this post</a></li>
  <li><a href="https://www.reddit.com/r/netsec/comments/2m2zpb/the_perils_of_using_an_sshagent/">The perils of using an ssh-agent</a> - Post which fails to mention ProxyCommand</li>
  <li><a href="https//sshmenu.sourceforge.net/articles/transparent-mulithop.html">Good post on ssh-agent and ProxyCommand</a></li>
  <li><a href="https://github.com/alonbl/vpnc-scripts/blob/master/vpnc-script-sshd">Putting vpnc into a Linux network namespace</a></li>
  <li><a href="https://lwn.net/Articles/580893/">Linux network namespaces in operation</a></li>
</ul>


</div>
<!--

<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>28 May 2016</span> <span class="seperator">~</span> <a href="/2016/05/28/jekyll-and-responsive-flickr-photos/">Jekyll and responsive Flickr photos</a></li>
    
      <li><span>23 Sep 2015</span> <span class="seperator">~</span> <a href="/2015/09/23/nginx-sso-Simple-offline-SSO-for-nginx/">nginx-sso - Simple offline SSO for nginx</a></li>
    
      <li><span>20 Aug 2015</span> <span class="seperator">~</span> <a href="/2015/08/20/Persistent-AppCache-Injections/">Persistent AppCache Injections</a></li>
    
  </ul>
</div>

-->
<div class="comments">
	<h3>Comments</h3>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'heipei'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    

</div>

            <div class="footer">
                <div class="contact">
                    <p>Johannes Gilger - <a href="https://twitter.com/heipei/">@heipei</a></p>
                </div>
                <div class="rss">
                    <i class="icon-rss"></i> <a href="/atom.xml">Atom Feed</a>
                </div>
            </div>
        </div>
    </body>
    <html>
